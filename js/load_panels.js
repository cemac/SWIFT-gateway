var manifest = {
    CRR: {
        //path: "NWCSAF_images/CRR/",
        manifest: [
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T153000Z.crr_intensity.png", id: "CRR_tm90"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T154500Z.crr_intensity.png", id: "CRR_tm75"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T160000Z.crr_intensity.png", id: "CRR_tm60"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T161500Z.crr_intensity.png", id: "CRR_tm45"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T163000Z.crr_intensity.png", id: "CRR_tm30"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T164500Z.crr_intensity.png", id: "CRR_tm15"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z.crr_intensity.png", id: "CRR_t0"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_015.crr_intensity.png", id: "CRR_tp15"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_030.crr_intensity.png", id: "CRR_tp30"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_045.crr_intensity.png", id: "CRR_tp45"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_060.crr_intensity.png", id: "CRR_tp60"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_075.crr_intensity.png", id: "CRR_tp75"},
            {src: "NWCSAF_images/CRR/S_NWC_CRR_MSG4_WestAfrica-VISIR_20210303T170000Z_090.crr_intensity.png", id: "CRR_tp90"},
        ]},
    "PC-Ph": {
        //path: "NWCSAF_images/PC-Ph/",
        manifest: [
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T153000Z.pcph.png", id: "PC-Ph_tm90"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T154500Z.pcph.png", id: "PC-Ph_tm75"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T160000Z.pcph.png", id: "PC-Ph_tm60"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T161500Z.pcph.png", id: "PC-Ph_tm45"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T163000Z.pcph.png", id: "PC-Ph_tm30"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T164500Z.pcph.png", id: "PC-Ph_tm15"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z.pcph.png", id: "PC-Ph_t0"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_015.pcph.png", id: "PC-Ph_tp15"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_030.pcph.png", id: "PC-Ph_tp30"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_045.pcph.png", id: "PC-Ph_tp45"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_060.pcph.png", id: "PC-Ph_tp60"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_075.pcph.png", id: "PC-Ph_tp75"},
            {src: "NWCSAF_images/PC-Ph/S_NWC_PC-Ph_MSG4_WestAfrica-VISIR_20210303T170000Z_090.pcph.png", id: "PC-Ph_tp90"},
        ]},
    "HRW": {
        //path: "NWCSAF_images/HRW/",
        manifest: [
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T153000Z.p_400-600hPa_combined.png", id: "HRW_tm90"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T154500Z.p_400-600hPa_combined.png", id: "HRW_tm75"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T160000Z.p_400-600hPa_combined.png", id: "HRW_tm60"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T161500Z.p_400-600hPa_combined.png", id: "HRW_tm45"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T163000Z.p_400-600hPa_combined.png", id: "HRW_tm30"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T164500Z.p_400-600hPa_combined.png", id: "HRW_tm15"},
            {src: "NWCSAF_images/HRW/S_NWC_HRW_MSG4_WestAfrica-VISIR_20210303T170000Z.p_400-600hPa_combined.png", id: "HRW_t0"},
        ]},
        "RDT": {
        //path: "NWCSAF_images/RDT/",
        manifest: [
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T153000Z.rdt.png", id: "RDT_tm90"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T154500Z.rdt.png", id: "RDT_tm75"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T160000Z.rdt.png", id: "RDT_tm60"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T161500Z.rdt.png", id: "RDT_tm45"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T163000Z.rdt.png", id: "RDT_tm30"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T164500Z.rdt.png", id: "RDT_tm15"},
            {src: "NWCSAF_images/RDT/S_NWC_RDT-CW_MSG4_WestAfrica-VISIR_20210303T170000Z.rdt.png", id: "RDT_t0"},
        ]}
};

var preload = {};
var stage;
var num_steps = 12;  // total number of backward and forward steps (not including t0)
var fwd_steps = 6;  // number of forward steps

function init() {

    // Load images for initial panel selection
    Array.from(document.getElementsByClassName("panel")).map(setupPanel);

    // Set up display controls
    stage = new createjs.Stage("canvas");
    //stage.enableMouseOver(10);

    // Set up slider to display required number of time points, set value to t0
    var slider = new Slider(0, num_steps, 600, 35)
        .set({x: 35, y: 0, value: num_steps - fwd_steps,
              trackColor: "#DBE7F1", // rgba(70, 138, 185, 0.2)
              thumbColor: "#468AB9"});
    slider.on("change", sliderChange);
    stage.addChild(slider);
    stage.update();

    // Set up arrows
    var arrows = new Arrows(35, 35, 600).set({x:0, y:0, color: "#468AB9"});
    arrows.on("click", arrowClick);
    stage.addChild(arrows);
    stage.update();
}

function setupPanel(panel) {

    let queue = new createjs.LoadQueue(true);
    queue.on("progress", handleProgress, null, false, {id: panel.id});
    queue.on("complete", handleComplete, null, false, {id: panel.id});
    queue.on("fileload", handleFileLoad, null, false, {id: panel.id});
    queue.on("error", handleFileError, null, false, {id: panel.id});

    preload[panel.id] = queue;

    const select = document.getElementById(panel.id+"_select");
    select.addEventListener("change", changeSelect);

    loadPanel(panel.id, select.value);
}

function changeSelect(event) {
    const panelId = event.target.id.split("_")[0];
    console.log("Changed select for", panelId, ":", event.target.value);
    loadPanel(panelId, event.target.value);
}

function loadPanel(panelId, value) {
    console.log("Loading", panelId);

    if (typeof value === 'undefined') {
        value = document.getElementById(panelId+"_select").value;
    }

    const loaded = Object.keys(preload[panelId]._loadItemsById).map(x => x.split("_")[0]);

    if (loaded.indexOf(value) == -1) {
        // load manifest for selected product
        console.log("Loading manifest for", value);
        preload[panelId].loadManifest(manifest[value]);
    } else {
        // display previously loaded images
        updateImage(panelId);
    }
}

function handleProgress(event, data) {
    //console.log("handleProgress");
}

function handleComplete(event, data) {
    var panelId = data.id;
    updateImage(panelId);
}

function handleFileLoad(event, data) {
    var itemId = event.item.id;
    var panelId = data.id;

    // Get a reference to the loaded image (<img/>)
    var img = event.result;

    // Could use loader bar to indicate progress instead of/as well as
    // displaying images
    addImage(img, panelId, itemId);
}

function handleFileError(event) {
    switch (event.title) {
    case "FILE_LOAD_ERROR":
        console.log("Couldn't load file:", event.data.src);
        break;
    default:
        console.log("Error loading file:", event.title);
    }
}

function addImage(img, panelId, id) {

    if (img == null) {
        // set current image to grayscale and return
        document.getElementById(panelId).firstChild.style.filter = "grayscale(100%)";
        return;
    }

    // Add image via DOM manipulation
    var div = document.getElementById(panelId);
    div.innerHTML = "";
    var r = img.width / img.height;
    var ir = 0;
    if (div.clientHeight > 0) {
        ir = div.clientWidth / div.clientHeight;
    }
    if (r > ir) {
        img.width = div.clientWidth;
        img.height = div.clientWidth / r;
    } else {
        img.height = div.clientHeight;
        img.width = div.clientHeight * r;
    }
    img.style.filter = "";
    div.appendChild(img);
}

function updateImage(panelId, value) {
    if (typeof value === 'undefined') {
        // Set displayed image to match current slider setting
        value = stage.children.filter(x => x.name == 'Slider')[0].value;
    }
    var x = Math.round(value);  // 0 to num_steps
    var offset = (x - (num_steps - fwd_steps))*15;
    var id = "t0";
    if (offset != 0) {
        id = (offset < 0 ? "tm" : "tp") + Math.abs(offset);
    }
    var product = document.getElementById(panelId+"_select").value;
    var imgId = product+"_"+id;

    // Add image from preloaded items
    var img = preload[panelId].getResult(imgId);
    addImage(img, panelId, imgId);

    // Extract timestamp and forecast point
    // FIXME: this depends on filenames having a consistent form which
    // might not be the case for non-NWCSAF products
    var item = preload[panelId].getItem(imgId);
    if (item != null) {
        var ts = item.src.split("/");
        ts = ts[ts.length-1].split(".")[0].split("_").slice(5);
        document.getElementById("resource_info").innerHTML =
            "Displaying images for " +
            ts.toString().replace(",", " + ");
    }
}

function updatePanel(panel) {
    updateImage(panel.id, this.value);
}

function sliderChange(event) {
    // Update all panels to display correct image
    Array.from(document.getElementsByClassName("panel"))
        .map(updatePanel, this);

    // Update stage to refresh slider
    stage.update();
}

function arrowClick(event) {
    //console.log("Clicked", event.target.value);
    const adj = event.target.value == "back" ? -1 : 1;
    event.target.parent.children.filter(x => x.name == 'Slider')[0].adjust(adj);
}
